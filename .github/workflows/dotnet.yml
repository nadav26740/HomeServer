# This workflow will build a .NET project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net

name: Build backend NET

on:
  push:
    branches: [ "master", "GitActions" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-windows:
    runs-on: windows-latest

    defaults:
      run:
        working-directory: ./backend/HomeServer-Backend-win
    
    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    - name: Restore dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --no-restore
    # - name: Test
    #   run: dotnet test --no-build --verbosity normal

  build-ubuntu:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python_ver: ["3.12"]    

    defaults:
      run:
        working-directory: ./backend/HomeServer-Backend-win
    
    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x
    - name: Restore dependencies
      run: dotnet restore
    - name: Build
      run: dotnet build --no-restore

    - name: PreTests Set up Python 3.13 # Example name for the step
      uses: actions/setup-python@v5 # Uses the setup-python action
      with:
        python-version: ${{ matrix.python_ver }} # Specifies the desired Python version

    - name: Run And Test
      run: |
        echo "Starting the API..."
        dotnet run --no-build --verbosity normal &
        API_PID = $!
        sleep 5 # Wating for the API to start
        
        # Run the Python test script
        echo "Running API tests..."
        python ../Tests/API_Test.py
        
        sleep 10 # Allow some time for the API to finish processing
        echo "Killing the API..."
        kill $API_PID
    # - name: Test
    #   run: dotnet test --no-build --verbosity normal
  
